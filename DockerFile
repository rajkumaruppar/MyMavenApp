# Step 1: Use Maven 3.9 to build the Java application
FROM maven:3.9-openjdk-11-slim AS build

# Set working directory for Maven build inside the container
WORKDIR /app

# Copy the Maven POM file and source code to the container
COPY /var/lib/jenkins/workspace/java_step_2/pom.xml ./
COPY /var/lib/jenkins/workspace/java_step_2/src ./src

# Step 2: Build the application (skip tests for faster build)
RUN mvn clean package -DskipTests

# Step 3: Use Tomcat 9 with OpenJDK 11 to run the application
FROM tomcat:9-jdk11-openjdk

# Set working directory for Tomcat inside the container
WORKDIR /usr/local/tomcat/webapps

# Copy the WAR file from the build stage into Tomcat's webapps folder
COPY --from=build /app/target/*.war /usr/local/tomcat/webapps/ROOT.war

# Step 4: Expose port 8000 (Tomcat default will be replaced with 8000)
EXPOSE 8000

# Step 5: Modify Tomcat's server.xml to use port 8000 instead of the default 8080
RUN sed -i 's/8080/8000/g' /usr/local/tomcat/conf/server.xml

# Step 6: Start Tomcat when the container runs
CMD ["catalina.sh", "run"]

